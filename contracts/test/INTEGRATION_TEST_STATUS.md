# Integration Test Status: Real Halo2 Proof Verification

**Last Updated**: 2025-11-02 02:45 UTC
**Status**: üî¥ BLOCKED - EVM verification failing despite ceremony params fix
**Circuit**: District Membership (Single-Tier K=14)

## Executive Summary

The integration test that verifies real Halo2 proofs from our Rust circuit in the EVM verifier is currently FAILING. While we successfully identified and fixed a ceremony parameter incompatibility issue (Ethereum raw vs Axiom challenge_0085), the EVM verification still fails with `PrecompileError` on BN254 elliptic curve operations.

**Key Finding**: This is NOT a ceremony parameter issue anymore. The proof verifies successfully in Rust with Axiom params, but the EVM verifier rejects the curve points as invalid, indicating a deeper encoding/format incompatibility.

---

## Chronology of Investigation

### Phase 1: Initial Failure (2025-11-01)

**Symptom**: Integration test failing with `PrecompileError` on BN254 ecadd/ecmul precompiles

**Initial Hypothesis**: Ceremony parameter mismatch between proof generation and verifier

**Evidence**:
- Test was using `ceremony_params_k14.bin` from Ethereum perpetual-powers-of-tau
- Verifier was generated with same params
- Proof verified in Rust but failed in EVM

### Phase 2: Root Cause Discovery (2025-11-02 00:30 UTC)

**Discovery**: Axiom's snark-verifier v0.1.7 requires `challenge_0085` ceremony format, NOT raw perpetual-powers-of-tau

**Evidence**:
- Web search found Axiom uses specific ceremony format from their S3 bucket
- Blake2b-512 hash comparison:
  - Ethereum raw params: `91f59ebe47e55c18a318724a1b3fbf9a461d2e1c9f78417e1c33e2acaeeb9294...`
  - Axiom challenge_0085: `5d56001304a118d53e48bb5b512c125497d58f16af5c115ac6b2360fe515f77f...`
- Files are completely different (confirmed via `shasum`)

**Actions Taken**:
1. Downloaded Axiom params: `wget https://axiom-crypto.s3.amazonaws.com/challenge_0085/kzg_bn254_14.srs -O axiom_params_k14.srs`
2. Updated `prover.rs` to load `axiom_params_k14.srs` instead of `ceremony_params_k14.bin`
3. Updated `generate_verifier.rs` to use same Axiom params
4. Regenerated verifier: 20,143 bytes, NEW VK hash `15f6065428deecc9` (changed from `5cb1fc19e70bcd15`)
5. Regenerated proof with matching Axiom params

**Result**: ‚úÖ Proof verifies successfully in Rust with Axiom params

### Phase 3: EVM Failure Persists (2025-11-02 02:20 UTC)

**Symptom**: Despite ceremony params fix, EVM test still fails with `PrecompileError`

**Test Output**:
```
[FAIL: Verifier call should succeed] test_RealProofVerifies() (gas: 1056951039)
...
[6000] PRECOMPILES::ecmul(...) [staticcall]
‚îî‚îÄ ‚Üê [Return] (valid point)

[0] PRECOMPILES::ecadd(3292585791..., 6757343717..., 29563384913..., 10998793439...) [staticcall]
‚îî‚îÄ ‚Üê [PrecompileError] 0x

[0] PRECOMPILES::ecmul(77067109849..., 40131064142..., 17837912308...) [staticcall]
‚îî‚îÄ ‚Üê [PrecompileError] 0x
```

**Analysis**:
- First ecmul succeeds and returns valid curve points
- First ecadd FAILS - rejects points as invalid for BN254 curve
- Subsequent operations fail leading to out of gas

**Implication**: The curve points being passed to BN254 precompiles are invalid, suggesting:
1. Proof format mismatch between Rust and EVM
2. Field element serialization issues (endianness, encoding)
3. Commitment encoding differences
4. Possible transcript type mismatch

---

## Technical Details

### Current Configuration

**Ceremony Parameters**:
- Source: `https://axiom-crypto.s3.amazonaws.com/challenge_0085/kzg_bn254_14.srs`
- File: `/Users/noot/Documents/voter-protocol/packages/crypto/circuits/kzg_params/axiom_params_k14.srs`
- Size: 2,097,412 bytes (2.0M)
- Blake2b-512 hash: `5d56001304a118d53e48bb5b512c125497d58f16af5c115ac6b2360fe515f77f9c897d824b8824c0f2aff0a65b6f12c1cd7725c5a3631aade5731acf3f869ed8`
- Format: Axiom challenge_0085 (snark-verifier v0.1.7 compatible)

**Verifier**:
- Generation date: 2025-11-01 19:20 UTC
- Bytecode size: 20,143 bytes (18% under EIP-170 24KB limit)
- VK hash: `15f6065428deecc9`
- Circuit: Single-tier K=14, 3 public outputs
- Generated by: `packages/crypto/circuits/bin/generate_verifier.rs`
- Uses: `snark_verifier_sdk::evm::gen_evm_verifier_shplonk`

**Proof**:
- Generation date: 2025-11-02 02:20 UTC
- Size: 3,328 bytes
- Format: SHPLONK with Blake2bWrite transcript
- ‚úÖ Verifies in Rust: YES
- ‚ùå Verifies in EVM: NO (PrecompileError)
- Public inputs: 3 field elements (district_root, nullifier, action_id)

### Calldata Construction

**Current Approach** (Integration.t.sol):
```solidity
bytes memory callData = abi.encodePacked(
    testProof.districtRoot,   // bytes32 (32 bytes)
    testProof.nullifier,      // bytes32 (32 bytes)
    testProof.actionId,       // bytes32 (32 bytes)
    testProof.proof          // bytes (3328 bytes)
);
// Total: 96 bytes public inputs + 3328 bytes proof = 3424 bytes

(bool success, bytes memory result) = address(verifier).staticcall(callData);
```

**Field Element Serialization** (prover.rs):
```rust
fn fr_to_hex(value: Fr) -> String {
    use halo2_base::halo2_proofs::halo2curves::serde::SerdeObject;
    let mut bytes_vec = Vec::new();
    value.write_raw(&mut bytes_vec).expect("Failed to serialize Fr");
    // Pad to 32 bytes if needed
    while bytes_vec.len() < 32 {
        bytes_vec.push(0);
    }
    format!("0x{}", hex::encode(bytes_vec))
}
```

**Proof Serialization** (prover.rs):
```rust
// Generate proof using Blake2bWrite transcript
let mut transcript = Blake2bWrite::<_, _, Challenge255<_>>::init(vec![]);
create_proof::<...>(&self.params, &self.pk, &[builder], &[&[&public_instances]], OsRng, &mut transcript)?;
Ok(transcript.finalize())
```

---

## Key Questions (Unresolved)

1. **Transcript Type Mismatch?**
   - Prover uses: `Blake2bWrite`
   - EVM verifier generated by: `gen_evm_verifier_shplonk`
   - Axiom example uses: `EvmTranscript` explicitly
   - **Question**: Does `gen_evm_verifier_shplonk` expect a different transcript format?

2. **Proof Encoding**:
   - How does snark-verifier SDK expect the proof bytes to be formatted?
   - Is there an `encode_calldata()` function we should be using?
   - Axiom example shows: `let calldata = encode_calldata(&instances, &proof);`

3. **Field Element Encoding**:
   - Are Fr values correctly serialized with `write_raw()`?
   - Is the endianness correct for EVM (big-endian vs little-endian)?
   - Should we be using a different serialization method?

4. **Public Input Format**:
   - Is `abi.encodePacked()` the correct format?
   - Should public inputs be encoded differently for snark-verifier?

---

## Next Steps (Priority Order)

### 1. Investigate snark-verifier SDK Examples ‚ö° CRITICAL

**Action**: Examine Axiom's working integration examples
- Look at: `axiom-crypto/snark-verifier` repo examples
- Specifically: `evm-verifier-with-accumulator.rs`
- Find: How they encode proofs and calldata for EVM
- Check: If they use special encoding functions

### 2. Check Transcript Compatibility

**Action**: Verify transcript type compatibility
- Confirm what transcript `gen_evm_verifier_shplonk` expects
- Check if we need to use `EvmTranscript` in prover instead of `Blake2bWrite`
- Look for documentation on SHPLONK transcript requirements

### 3. Test with Axiom's encode_calldata

**Action**: Try using proper calldata encoding
- Find snark-verifier SDK's `encode_calldata()` function
- Update proof export to use proper encoding
- Regenerate test proof with correct format

### 4. Contact Axiom/PSE for Guidance

**Action**: Seek expert help if investigation doesn't resolve
- Post in Privacy & Scaling Explorations channels
- Ask about known issues with snark-verifier v0.1.7 EVM integration
- Request working example of Halo2 proof verification on EVM with challenge_0085

---

## Files Modified

### Ceremony Parameters
- **Added**: `/Users/noot/Documents/voter-protocol/packages/crypto/circuits/kzg_params/axiom_params_k14.srs`
- Downloaded from: `https://axiom-crypto.s3.amazonaws.com/challenge_0085/kzg_bn254_14.srs`
- Blake2b-512: `5d56001304a118d5...` (verified)

### Rust Code
- **Modified**: `/Users/noot/Documents/voter-protocol/packages/crypto/circuits/src/prover.rs`
  - Changed ceremony params path: `axiom_params_k14.srs`
  - Added Blake2b hash verification
  - Updated comments to reference Axiom challenge_0085

- **Modified**: `/Users/noot/Documents/voter-protocol/packages/crypto/circuits/src/bin/generate_verifier.rs`
  - Changed ceremony params path: `axiom_params_k14.srs`
  - Added Blake2b hash verification
  - Ensured consistency with prover params

### Generated Artifacts
- **Regenerated**: `/Users/noot/Documents/voter-protocol/contracts/src/Halo2Verifier.bytecode`
  - Date: 2025-11-01 19:20 UTC
  - Size: 20,143 bytes
  - VK hash: `15f6065428deecc9` (CHANGED from `5cb1fc19e70bcd15`)

- **Regenerated**: `/Users/noot/Documents/voter-protocol/contracts/test/fixtures/proof_integration_test.json`
  - Date: 2025-11-02 02:20 UTC
  - Size: 3,328 bytes proof
  - ‚úÖ Verifies in Rust
  - ‚ùå Fails in EVM (PrecompileError)

- **Regenerated**: `/Users/noot/Documents/voter-protocol/packages/crypto/circuits/proof_integration_test.json`
  - Same as above (generated in circuits dir, copied to contracts/test/fixtures/)

### Documentation
- **Updated**: `/Users/noot/Documents/voter-protocol/contracts/src/Halo2Verifier.deployment.md`
  - New VK hash: `15f6065428deecc9`
  - Updated generation date
  - Noted Axiom params requirement

---

## Success Criteria

- [ ] EVM test `test_RealProofVerifies()` passes
- [ ] No PrecompileError on BN254 operations
- [ ] Gas cost within expected range (300-500k)
- [ ] Proof with wrong inputs correctly rejected
- [ ] Tampered proof correctly rejected

---

## Risk Assessment

**Impact**: üî¥ CRITICAL - Cannot deploy real verifier until this is resolved

**Workarounds**:
1. Deploy with `MockHalo2Verifier` for testnet (NOT production)
2. Add warnings that real ZK verification is not active
3. Use off-chain verification as stopgap

**Timeline**:
- **Ideal**: Resolve within 48 hours (2025-11-04)
- **Maximum**: 1 week before considering alternative approaches
- **Escalation**: Contact Axiom/PSE if not resolved within 3 days

---

## References

### Axiom Resources
- Axiom S3 ceremony params: `https://axiom-crypto.s3.amazonaws.com/challenge_0085/`
- snark-verifier repo: `https://github.com/axiom-crypto/snark-verifier`
- axiom-eth examples: `https://github.com/axiom-crypto/axiom-eth`
- uniswap-v3-oracles: `https://github.com/axiom-crypto/uniswap-v3-oracles` (production example)

### Documentation
- Axiom docs: `https://docs.axiom.xyz`
- snark-verifier SDK docs: (check GitHub repo)
- Trail of Bits audits: (linked in snark-verifier README)

### Related Issues
- None found yet - this appears to be a unique integration issue

---

**Document Status**: LIVING DOCUMENT - Update as investigation progresses
**Owner**: Lead ZK Engineer
**Last Reviewed**: 2025-11-02 02:45 UTC
