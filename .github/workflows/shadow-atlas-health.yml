# Shadow Atlas Health Check - GitHub Actions Workflow
#
# Pre-launch observability via GitHub Actions (free tier):
# - Scheduled health checks (every 6 hours)
# - Creates GitHub Issue on critical failures
# - No external infrastructure needed
#
# USAGE:
# Copy this file to .github/workflows/shadow-atlas-health.yml
#
# CONFIGURATION:
# Set these secrets in your repository:
# - SLACK_WEBHOOK_URL (optional): Slack webhook for alerts
#
name: Shadow Atlas Health Check

on:
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/crypto/package-lock.json

      - name: Install dependencies
        working-directory: packages/crypto
        run: npm ci

      - name: Run health check
        id: health
        run: |
          # Run health check and capture output
          npx tsx .github/workflows/scripts/shadow-atlas/health-check.ts > health-output.json 2>&1 || true

          # Parse result
          if [ -f health-output.json ]; then
            HEALTHY=$(cat health-output.json | jq -r '.healthy // false')
            ISSUES=$(cat health-output.json | jq -r '.issues | length // 0')

            echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
            echo "issues=$ISSUES" >> $GITHUB_OUTPUT

            # Output summary
            cat health-output.json | jq .
          else
            echo "healthy=false" >> $GITHUB_OUTPUT
            echo "issues=1" >> $GITHUB_OUTPUT
            echo "Health check script failed to produce output"
          fi

      - name: Create issue on failure
        if: steps.health.outputs.healthy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let healthData = { issues: ['Health check failed'] };

            try {
              const content = fs.readFileSync('health-output.json', 'utf8');
              healthData = JSON.parse(content);
            } catch (e) {
              console.log('Could not parse health output');
            }

            const issueTitle = 'üö® Shadow Atlas Health Check Failed';
            const issueBody = `
            ## Health Check Failure

            The scheduled health check detected issues with Shadow Atlas.

            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}

            ### Issues
            ${healthData.issues?.map(i => `- ${i}`).join('\n') || '- Unknown issue'}

            ### Metrics
            - Extraction Success Rate: ${(healthData.extractionSuccessRate * 100).toFixed(1)}%
            - Validation Pass Rate: ${(healthData.validationPassRate * 100).toFixed(1)}%
            - Avg Job Duration: ${healthData.avgJobDurationMs}ms

            ### Providers
            ${Object.entries(healthData.providerAvailability || {})
              .map(([k, v]) => `- ${k}: ${v ? '‚úÖ' : '‚ùå'}`)
              .join('\n') || 'No provider data'}

            ---
            *This issue was automatically created by the Shadow Atlas health check workflow.*
            `;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'shadow-atlas-health'
            });

            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['shadow-atlas-health', 'automated']
              });
              console.log('Created new health check issue');
            } else {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Update: ${new Date().toISOString()}\n\n${issueBody}`
              });
              console.log('Added comment to existing issue');
            }

      - name: Close issue on recovery
        if: steps.health.outputs.healthy == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'shadow-atlas-health'
            });

            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ‚úÖ Resolved\n\nHealth check passed at ${new Date().toISOString()}`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              console.log(`Closed issue #${issue.number}`);
            }

      - name: Notify Slack (optional)
        if: steps.health.outputs.healthy == 'false' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"üö® Shadow Atlas health check failed! Check GitHub Issues for details."}' \
            $SLACK_WEBHOOK_URL
