# Golden Vectors for Boundary Reconstruction

## Purpose

Golden vectors are **human-verified reference data** used for regression testing of the boundary reconstruction pipeline. They represent known-correct ward/district boundaries that serve as the ground truth for validating reconstruction algorithms.

## Philosophy

- **Golden vectors are TRUTH** - They are verified by humans against authoritative sources, not generated by algorithms
- **Binary pass/fail** - Reconstruction either matches the golden vector within tolerance or it doesn't
- **Regression prevention** - Any deviation from golden vectors blocks deployment
- **Explicit tolerance** - Validation thresholds are documented and justified
- **Human verification required** - New golden vectors require manual verification before use in production

## File Structure

Each golden vector is a JSON file containing:

```typescript
interface GoldenVector {
  cityFips: string;                    // City FIPS code
  cityName: string;                    // City name
  state: string;                       // State abbreviation
  expectedWardCount: number;           // Number of wards/districts
  legalDescriptions: WardLegalDescription[];  // Input descriptions
  expectedPolygons: Feature<Polygon>[]; // Output polygons (verified)
  verifiedAt: string;                  // ISO 8601 timestamp
  verificationSource: string;          // How verification was performed
  notes?: string;                      // Additional context
}
```

## Verification Levels

### Level 1: Approximate (Template)
- **Status**: `metadata.verificationStatus = "pending_human_verification"`
- **Precision**: `metadata.precisionLevel = "approximate"`
- **Use case**: Documents verification gap, serves as template
- **Blocked from**: Production validation
- **Example**: `north-kansas-city-mo.json` (current state)

### Level 2: Human Verified
- **Status**: `metadata.verificationStatus = "human_verified"`
- **Precision**: `metadata.precisionLevel = "verified"`
- **Source**: Official city maps, GIS data, or legal documents
- **Use case**: Production regression testing
- **Requirements**:
  - Obtained from authoritative source (city hall, GIS office)
  - Verified against official maps/documents
  - Coordinates manually extracted or digitized
  - Verification methodology documented

### Level 3: Ground Truth (Gold Standard)
- **Status**: `metadata.verificationStatus = "ground_truth"`
- **Precision**: `metadata.precisionLevel = "surveyed"`
- **Source**: Official GIS shapefiles from municipality
- **Use case**: Benchmark for algorithm accuracy
- **Requirements**:
  - Official GIS data directly from municipality
  - Includes metadata (datum, projection, accuracy)
  - Multiple verification sources cross-referenced
  - Legal descriptions match official ordinances

## Creating a New Golden Vector

### Step 1: Research and Acquire Data

1. **Identify the city**:
   - City name and state
   - FIPS code (from Census Bureau)
   - Ward/district count
   - Redistricting date

2. **Locate official sources**:
   - City website (look for redistricting pages, ward maps)
   - City clerk or planning department
   - GIS office or public works department
   - State redistricting commission
   - Census Bureau TIGER/Line files (for city boundaries)

3. **Request official data**:
   - Ward map PDF (high resolution)
   - GIS shapefiles (ideal)
   - Ordinance or resolution text with legal descriptions
   - Population data by ward

### Step 2: Extract or Digitize Boundaries

**Option A: GIS Shapefiles Available**
```bash
# Convert shapefile to GeoJSON
ogr2ogr -f GeoJSON output.json input.shp

# Validate and format
# Extract ward polygons, assign properties
```

**Option B: PDF Map Digitization**
```bash
# Georeference PDF map (QGIS or similar)
# Manually trace ward boundaries
# Export as GeoJSON
# Verify coordinates against known landmarks
```

**Option C: Legal Description Parsing**
```bash
# Extract street names and intersections from ordinance text
# Use reconstruction pipeline to generate initial boundaries
# Manually verify and adjust against official maps
```

### Step 3: Create Golden Vector File

```bash
# File naming: {city-name}-{state}.json
# Use kebab-case, all lowercase
# Example: north-kansas-city-mo.json
```

```json
{
  "cityFips": "XXXXXXX",
  "cityName": "Example City",
  "state": "XX",
  "expectedWardCount": 4,
  "metadata": {
    "precisionLevel": "verified",
    "dataSource": "official_gis",
    "redistrictingDate": "YYYY-MM-DD",
    "population": 12345,
    "idealDistrictPopulation": 3086,
    "verificationStatus": "human_verified",
    "verificationMethodology": "Obtained official GIS shapefiles from City Planning Department on YYYY-MM-DD. Converted to GeoJSON using ogr2ogr. Verified ward boundaries match PDF map published at [URL].",
    "datum": "WGS84",
    "coordinatePrecision": "6_decimal_places_meters"
  },
  "legalDescriptions": [
    {
      "cityFips": "XXXXXXX",
      "cityName": "Example City",
      "state": "XX",
      "wardId": "1",
      "wardName": "Ward 1",
      "segments": [
        {
          "index": 0,
          "referenceType": "street_centerline",
          "featureName": "Main Street",
          "direction": "east",
          "from": "intersection with Oak Avenue",
          "to": "intersection with Elm Street",
          "rawText": "beginning at the intersection of Main Street and Oak Avenue, thence easterly along Main Street to Elm Street",
          "parseConfidence": "high"
        }
      ],
      "source": {
        "type": "ordinance_text",
        "source": "https://example.com/ordinance-2021-123",
        "title": "Ordinance 2021-123: Ward Boundary Redistricting",
        "effectiveDate": "YYYY-MM-DD",
        "retrievedAt": "YYYY-MM-DD",
        "contentHash": "sha256:..."
      },
      "population": 3086
    }
  ],
  "expectedPolygons": [
    {
      "type": "Feature",
      "properties": {
        "wardId": "1",
        "wardName": "Ward 1",
        "cityFips": "XXXXXXX"
      },
      "geometry": {
        "type": "Polygon",
        "coordinates": [
          [
            [-94.123456, 39.123456],
            [-94.123456, 39.234567],
            [-94.234567, 39.234567],
            [-94.234567, 39.123456],
            [-94.123456, 39.123456]
          ]
        ]
      }
    }
  ],
  "verifiedAt": "YYYY-MM-DDTHH:mm:ss.sssZ",
  "verificationSource": "Official GIS shapefiles from City Planning Department",
  "notes": "Verified against official 2021 Ward Map published at [URL]. All coordinates extracted from authoritative GIS data."
}
```

### Step 4: Create Test File

Create `{city-name}-{state}.test.ts`:

```typescript
import { describe, test, expect } from 'vitest';
import { readFileSync } from 'fs';
import { join } from 'path';
import type { GoldenVector } from '../types';
import { deserializeGoldenVector } from '../golden-vector-validator';

describe('Example City Golden Vector', () => {
  let goldenVector: GoldenVector;

  test('loads and parses golden vector JSON', () => {
    const jsonPath = join(__dirname, 'example-city-xx.json');
    const jsonContent = readFileSync(jsonPath, 'utf-8');
    goldenVector = deserializeGoldenVector(jsonContent);
  });

  test('has correct metadata', () => {
    const jsonPath = join(__dirname, 'example-city-xx.json');
    const jsonContent = readFileSync(jsonPath, 'utf-8');
    goldenVector = deserializeGoldenVector(jsonContent);

    expect(goldenVector.cityFips).toBe('XXXXXXX');
    expect(goldenVector.cityName).toBe('Example City');
    expect(goldenVector.expectedWardCount).toBe(4);
  });

  test('all polygons have valid closed rings', () => {
    const jsonPath = join(__dirname, 'example-city-xx.json');
    const jsonContent = readFileSync(jsonPath, 'utf-8');
    goldenVector = deserializeGoldenVector(jsonContent);

    for (const polygon of goldenVector.expectedPolygons) {
      const ring = polygon.geometry.coordinates[0];
      expect(ring.length).toBeGreaterThanOrEqual(4);

      const first = ring[0];
      const last = ring[ring.length - 1];
      expect(first[0]).toBeCloseTo(last[0], 6);
      expect(first[1]).toBeCloseTo(last[1], 6);
    }
  });

  test('is verified and ready for production', () => {
    const jsonPath = join(__dirname, 'example-city-xx.json');
    const jsonContent = readFileSync(jsonPath, 'utf-8');
    const parsed = JSON.parse(jsonContent);

    expect(parsed.metadata.verificationStatus).toBe('human_verified');
    expect(parsed.metadata.precisionLevel).not.toBe('approximate');
  });
});
```

### Step 5: Document Verification

Add verification checklist to test file:

```typescript
/**
 * VERIFICATION CHECKLIST:
 *
 * [x] Obtained official ward map from City Planning Department (2024-01-15)
 * [x] Obtained GIS shapefiles (format: ESRI Shapefile, datum: WGS84)
 * [x] Converted to GeoJSON using ogr2ogr 3.8.0
 * [x] Verified coordinates match PDF map published at [URL]
 * [x] Verified ward populations match 2020 Census data
 * [x] Cross-referenced with ordinance text (Ordinance 2021-123)
 * [x] Validated all polygons are closed rings
 * [x] Validated all wards tessellate (no gaps/overlaps)
 * [x] Updated metadata with verification details
 * [x] Computed SHA-256 hash of source documents
 * [x] Documented acquisition methodology
 *
 * VERIFICATION DATE: 2024-01-20
 * VERIFIED BY: [Name/Organization]
 * SOURCE DOCUMENTS:
 * - wards.shp (sha256:abc123...)
 * - ward_map_2021.pdf (sha256:def456...)
 * - ordinance_2021-123.pdf (sha256:ghi789...)
 */
```

## Validation Thresholds

When using golden vectors for regression testing:

```typescript
const config: GoldenVectorConfig = {
  maxHausdorffDistance: 50,      // 50 meters
  maxAreaDifferenceRatio: 0.05,   // 5%
  maxCentroidDistance: 100,       // 100 meters
  minOverlapRatio: 0.90,          // 90% IoU
  failFast: false,
};
```

**Rationale**:
- **Hausdorff distance (50m)**: Accounts for OSM street geometry variations
- **Area difference (5%)**: Allows for coordinate precision differences
- **Centroid distance (100m)**: Detects major boundary errors
- **IoU (90%)**: Ensures substantial overlap despite minor variations

## Current Golden Vectors

### North Kansas City, MO
- **File**: `north-kansas-city-mo.json`
- **Status**: ⚠️ Approximate (pending verification)
- **Wards**: 4
- **Redistricting**: November 16, 2021
- **Action needed**: Obtain official ward map and GIS data from City Hall
- **Contact**: (816) 274-6000, 2010 Howell St, North Kansas City, MO 64116

## Best Practices

### DO:
✅ Obtain data from authoritative sources (city hall, GIS office)
✅ Document verification methodology in detail
✅ Include SHA-256 hashes of source documents
✅ Cross-reference multiple sources when possible
✅ Note any discrepancies or ambiguities in notes
✅ Use 6 decimal places for coordinates (~0.1m precision)
✅ Validate polygons are closed rings
✅ Verify wards tessellate (no gaps/overlaps)
✅ Include population data when available

### DON'T:
❌ Generate golden vectors algorithmically without human verification
❌ Use unverified data from third-party sources
❌ Assume approximate boundaries are accurate
❌ Skip documentation of verification process
❌ Use golden vectors marked "approximate" for production validation
❌ Mix coordinate systems without documenting
❌ Include personally identifiable information (PII)

## Regression Testing Workflow

1. **Baseline**: Run reconstruction on golden vector cities
2. **Store results**: Save validation metrics (IoU, Hausdorff, etc.)
3. **Pre-deployment**: Run reconstruction again before deploying changes
4. **Compare**: Use `detectRegressions()` to compare against baseline
5. **Block if regressed**: Fail CI/CD if any golden vector fails or degrades

```typescript
import { validateCityAgainstGolden, detectRegressions } from '../golden-vector-validator';

const baseline = previousValidationResult;
const current = validateCityAgainstGolden(reconstructedPolygons, goldenVector);

const { hasRegressions, regressions } = detectRegressions(baseline, current);

if (hasRegressions) {
  throw new Error(`Regressions detected:\n${regressions.join('\n')}`);
}
```

## Contributing

To contribute a new golden vector:

1. **Research**: Follow Step 1 above
2. **Create**: Use template structure
3. **Verify**: Complete verification checklist
4. **Test**: Write comprehensive tests
5. **Document**: Add to this README
6. **PR**: Submit with verification evidence (screenshots, documents, etc.)

Golden vectors are the foundation of quality assurance. Take time to verify accuracy.

## Resources

- [Census Bureau FIPS Codes](https://www.census.gov/library/reference/code-lists/ansi.html)
- [TIGER/Line Shapefiles](https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html)
- [OpenStreetMap](https://www.openstreetmap.org)
- [GeoJSON Specification](https://datatracker.ietf.org/doc/html/rfc7946)
- [QGIS (georeferencing tool)](https://qgis.org)

---

**Golden vectors are TRUTH. Treat them as sacred.**
